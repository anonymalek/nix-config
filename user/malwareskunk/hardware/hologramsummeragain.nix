{ config, lib, pkgs, systemPath, ... }:
let
  law = import (systemPath + /law.nix) {
    inherit pkgs lib systemPath;
  };
in
{
  imports =
    [
      ./hologramsummeragain-hw.nix
    ];

  hostname = "hologramsummeragain";

  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  networking.wireless.enable = true;
  networking.networkmanager.enable = true;

  services.xserver.enable = true;


  services.xserver.displayManager.gdm.enable = true;

  boot = {
    kernelModules = [
      "kvm-intel"
      "vfio_virqfd"
      "vfio_pci"
      "vfio_iommu_type1"
      "vfio"
    ];

    kernelParams = [
      "intel_iommu=on"
      "kvm.ignore_msrs=1"

      # TODO: single gpu passthrough
    ];
  };

  systemd.tmpfiles.rules = [
    "f /dev/shm/looking-glass 0660 malwareskunk qemu-libvirtd -"
  ];

  environment.systemPackages = with pkgs; [
    looking-glass-client
    libxfs
  ];

  hardware.bluetooth = {
    enable = true;
    powerOnBoot = false;
    package = pkgs.bluez;
  };

  hardware.pulseaudio.enable = false;

  boot.initrd.luks.devices = {
    luksroot = {
      device = "/dev/disk/by-uuid/9d12c4b6-4c2f-4072-b38e-8531d9757f92";
      allowDiscards = true;
      preLVM = true;
    };
  };

  services.pipewire = {
    enable = true;

    alsa = {
      enable = true;
      support32Bit = true;
    };

    pulse.enable = true;
    jack.enable = true;
  };

  services.blueman.enable = true;

  system.stateVersion = "24.05"; # Did you read the comment?
}
